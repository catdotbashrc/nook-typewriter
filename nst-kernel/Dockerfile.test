# QuillKernel Test Environment
# Builds the kernel and runs tests in Docker

FROM debian:11-slim

# Install build dependencies
RUN apt-get update && apt-get install -y \
    # Build essentials
    build-essential \
    bc \
    bison \
    flex \
    libssl-dev \
    # Cross compilation
    gcc-arm-linux-gnueabi \
    # Git for patches
    git \
    # Testing tools
    sparse \
    cppcheck \
    # Utils
    wget \
    curl \
    python3 \
    # Kernel build deps
    libncurses5-dev \
    rsync \
    cpio \
    && rm -rf /var/lib/apt/lists/*

# Create build user (avoid root builds)
RUN useradd -m -s /bin/bash builder
USER builder
WORKDIR /home/builder

# Copy kernel source
COPY --chown=builder:builder . /home/builder/nst-kernel/

WORKDIR /home/builder/nst-kernel

# Apply QuillKernel patches
RUN ./squire-kernel-patch.sh

# Set up cross-compilation environment
ENV ARCH=arm
ENV CROSS_COMPILE=arm-linux-gnueabi-

# Default command runs tests
CMD ["bash", "-c", "cd test && ./verify-build-simple.sh && echo 'Build verification passed!'"]