" Enhanced vimrc for Nook with zk integration
set nocompatible
set ttyfast
set backspace=indent,eol,start
set number
set wrap
set linebreak
set textwidth=0
set spell
syntax on
filetype plugin indent on

" Leader key
let mapleader = " "

" zk integration mappings
" Create new note with zk
nnoremap <leader>zn :!zk new --title "
nnoremap <leader>zd :!zk new --group daily<CR>
nnoremap <leader>zi :!zk new --group ideas<CR>

" Search notes with zk
nnoremap <leader>zs :!zk list --interactive<CR>
nnoremap <leader>zf :!zk edit --interactive<CR>
nnoremap <leader>zt :!zk tag list<CR>

" Open zk notebook directory
nnoremap <leader>zo :e ~/notes/<CR>

" Quick save and quit
nnoremap <leader>w :w<CR>
nnoremap <leader>q :q<CR>
nnoremap <leader>wq :wq<CR>

" Writing modes
nnoremap <leader>g :Goyo<CR>
nnoremap <leader>p :Pencil<CR>

" Draft mode
nnoremap <leader>dd :e ~/drafts/draft.txt<CR>

" Enable plugins
set runtimepath^=~/.vim/pack/plugins/start

" Goyo settings - perfect for E-Ink
let g:goyo_width = 70
let g:goyo_height = '100%'
let g:goyo_margin_top = 2
let g:goyo_margin_bottom = 2

" Pencil settings for better writing
let g:pencil#wrapModeDefault = 'soft'
let g:pencil#autoformat = 0
let g:pencil#conceallevel = 0

" Auto-enable Pencil for markdown and text files
augroup pencil
  autocmd!
  autocmd FileType markdown,mkd,text call pencil#init()
augroup END

" Lightline configuration - minimal for E-Ink
let g:lightline = {
      \ 'colorscheme': 'default',
      \ 'active': {
      \   'left': [ [ 'mode' ], [ 'filename' ] ],
      \   'right': [ [ 'lineinfo' ], [ 'wordcount' ] ]
      \ },
      \ 'component_function': {
      \   'wordcount': 'WordCount'
      \ },
      \ }

" Word count function for status line
function! WordCount()
  let s:old_status = v:statusmsg
  let position = getpos(".")
  exe ":silent normal g\<c-g>"
  let stat = v:statusmsg
  let s:word_count = 0
  if stat != ''
    let s:word_count = str2nr(split(v:statusmsg)[11])
  end
  let v:statusmsg = s:old_status
  call setpos('.', position)
  return s:word_count . ' words'
endfunction

" E-Ink friendly colors (high contrast)
highlight Normal ctermbg=white ctermfg=black
highlight LineNr ctermbg=white ctermfg=gray
highlight CursorLine cterm=bold
highlight SpellBad cterm=underline

" Save on Ctrl+S (familiar to writers)
nnoremap <C-s> :w<CR>
inoremap <C-s> <Esc>:w<CR>a

" Quit on Ctrl+Q
nnoremap <C-q> :q<CR>
inoremap <C-q> <Esc>:q<CR>

" Auto-save every 5 minutes
autocmd CursorHold,CursorHoldI * silent! update

" Set updatetime for auto-save
set updatetime=300000  " 5 minutes

" Disable swap files (we have auto-save)
set noswapfile
set nobackup

" Better search
set ignorecase
set smartcase
set incsearch
set hlsearch

" Clear search highlighting with Escape
nnoremap <Esc> :nohlsearch<CR>

" Status line always visible
set laststatus=2

" Show command being typed
set showcmd

" Tab settings for writing
set expandtab
set tabstop=2
set shiftwidth=2

" Better paragraph navigation
nnoremap { {zz
nnoremap } }zz

" Center screen on searches
nnoremap n nzz
nnoremap N Nzz

" Quick access to zk config
nnoremap <leader>zc :e ~/.config/zk/config.toml<CR>

" Markdown specific settings
autocmd FileType markdown setlocal spell spelllang=en_us
autocmd FileType markdown setlocal wrap linebreak nolist

" Start in insert mode for new files
autocmd BufNewFile * startinsert

" Medieval theme welcome message
echo "By quill and candlelight, we write..."